var Database={fetchAllPedidos:function(e){this._execute("select p.numero, p.id, p.id_solicitante, s.nome, DATE_FORMAT(STR_TO_DATE(p.data_de_compra, '%Y-%m-%d'), '%d-%m-%Y') as data_de_compra, (SELECT SUM (m.quantidade*m.preco) FROM materiais as m WHERE m.id_pedido = p.id) as total_materiais, (SELECT SUM (i.quantidade*i.preco) FROM insumos as i WHERE i.id_pedido = p.id) as total_insumos from pedidos as p INNER JOIN solicitantes as s ON s.id = p.id_solicitante",e)},findPedidoByNumero:function(e,t){var i="select p.numero, p.id, p.id_solicitante, s.nome, DATE_FORMAT(STR_TO_DATE(p.data_de_compra, '%Y-%m-%d'), '%d-%m-%Y') as data_de_compra, (SELECT SUM (m.quantidade*m.preco) FROM materiais as m WHERE m.id_pedido = p.id) as total_materiais, (SELECT SUM (i.quantidade*i.preco) FROM insumos as i WHERE i.id_pedido = p.id) as total_insumos from pedidos as p INNER JOIN solicitantes as s ON s.id = p.id_solicitante WHERE p.numero = "+e;this._execute(i,t)},findSolicitanteById:function(e,t){var i="SELECT * FROM solicitantes WHERE id = "+e;this._execute(i,t)},findSolicitanteByCpf:function(e,t){var i="SELECT * FROM solicitantes WHERE cpf = "+e;this._execute(i,t)},fetchAllSolicitantes:function(e){this._execute("SELECT * FROM solicitantes",e)},fetchPedidosPorDia:function(e){this._execute("select count(*) as total, day(STR_TO_DATE(data_de_compra, '%Y-%m-%d')) as day from pedidos p group by day(STR_TO_DATE(data_de_compra, '%Y-%m-%d'))",e)},fetchPedidosPorSolicitantes:function(e){this._execute("select count(*) total, s.nome from pedidos p inner join solicitantes s on s.id = p.id_solicitante group by p.id_solicitante",e)},_execute:function(e,t){mysqlQuery(e,function(e){var i=JSON.parse(e);t(i)})}},Validator=function(e,t){var i={required:function(t){return e.is("select")?"-1"!=e.val()||""!=e.val():e.is("input")?e.val().length>0:void 0},max:function(t){return e.val().length<=t},min:function(t){return e.val().length>=t}},a=[];this.validate=function(e){for(var t in a){var n=a[t];if(!i[n.name]||!i[n.name](n.opt))return void e(n,!1)}e({},!0)},function(){var e=t.split("|");for(var i in e){var n=e[i].split(":");a[n[0]]={name:n[0],opt:n[1]}}}()},Pedido=function(){var e={},t={};this.setData=function(t){e=t},this.getData=function(){return e},this.setSolicitante=function(e){t=e},this.get=function(t){return e[t]}},FormWizard=function(e,t,i){var a=$(e),n=[];this.initializeFields=function(){var e=this;for(var n in t)this.initializeField(n,t[n]);this.btnSubmit=a.find(".btn-submit"),this.btnSubmit.click(function(){e.allValidate()&&i()})},this.initializeField=function(e,t){t.select?$elField=a.find('select[name="'+e+'"]'):$elField=a.find('input[name="'+e+'"]'),n[e]={el:$elField,properties:t,status:!t.rules},t.rules&&(n[e].validator=new Validator($elField,t.rules)),this.createEvents(n[e]),t.isDate&&this.startDatepicker(n[e]),t.mask&&o(n[e],t.mask,t.onCompleteMask)};var o=function(e,t,i){var a={onComplete:i||function(){}};e.el.mask(t,a)};this.startDatepicker=function(e){var t=this;e.el.datepicker({format:"dd/mm/yyyy",language:"pt-BR",orientation:"bottom left"}).on("changeDate",function(i){e.validator&&t.validateField(e),t.verifySubmitEnaled(),e.properties&&e.properties.onChangeDate(i)})},this.createEvents=function(e){var t=this;e.el.on("keyup",function(i){e.validator&&t.validateField(n[$(this).attr("name")]),e.properties.keyUp&&e.properties.keyUp(i,e),t.verifySubmitEnaled()})},this.verifySubmitEnaled=function(){this.allValidate()?this.enableBtnSubmit():this.disableBtnSubmit()},this.validateField=function(e){e.validator.validate(function(t,i){e.status=i;var a=e.el.parent();e.properties.hasLoading&&(a=a.parent()),a.find(".validator-errors span").removeClass("show"),i?a.removeClass("has-error").addClass("has-success"):(a.find('.validator-errors span[data-error="'+t.name+'"]').addClass("show"),a.addClass("has-error"))})},this.validateAllFields=function(){for(var e in n)n[e].validator?this.validateField(n[e]):console.log(e)},this.allValidate=function(){for(var e in n)if(!n[e].status)return!1;return!0},this.setValue=function(e){for(var t in e)n[t]&&(n[t].properties.select?n[t].el.val(e[t]):n[t].properties.isDate?(n[t].el.datepicker("update",this.getDate(e[t])),this.validateField(n[t])):n[t].el.attr("value",e[t]))},this.getDate=function(e){var t=e.split("-");return new Date(t[2],t[1],t[0])},this.setEnabled=function(e){for(var t in e)n[e[t]]&&n[e[t]].el.removeAttr("disabled")},this.setAllEnabled=function(){for(var e in n)n[e].el.removeAttr("disabled")},this.setDisabled=function(e){for(var t in e)n[e[t]]&&n[e[t]].el.attr("disabled","disabled")},this.enableBtnSubmit=function(){this.btnSubmit.removeAttr("disabled")},this.disableBtnSubmit=function(){this.btnSubmit.attr("disabled","disabled")},this.get=function(e){return n[e].el.val()},this.unmask=function(e){return n[e].el.unmask()},this.getCleanValue=function(e){return n[e].el.cleanVal()},this.getAll=function(){var e={};for(var t in n)e[t]=n[t].el.val();return e},this.showLoading=function(e){n[e].el.parent().find(".image-loading").addClass("show fadeIn")},this.hideLoading=function(e){n[e].el.parent().find(".image-loading").removeClass("fadeIn show")},this.init=function(){this.initializeFields()},this.init()},Paginator=function(e,t,i){var a=this,n=$(e),o=$(t),s={},r=function(){n.click(function(){$(this).hasClass("enabled")&&a.setSelectedPage($(this).attr("href").replace("#",""))})};this.init=function(){r()},this.loadHtml=function(e,t,i){$.ajax({url:"views/"+e+".html"}).done(function(e){t.find(".content").html(e),i()})},this.setSelectedPage=function(e){a=this,o.find(".page").removeClass("show-page").addClass("hide-page"),o.find(".page .loading").removeClass("hide"),o.find(".page .content").removeClass("show"),this.selectedPage=o.find("div[data-page="+e+"]"),this.selectedPage.addClass("show-page").removeClass("hide-page");var t=function(){a.selectedPage.find(".loading").addClass("hide"),a.selectedPage.find(".content").addClass("show")};s[e]?i(e,this.selectedPage.data("title"),t):this.loadHtml(e,this.selectedPage,function(){i(e,a.selectedPage.data("title"),t)})}},CEP={getInfo:function(e,t){$.getJSON("https://viacep.com.br/ws/"+e+"/json/",function(e){if(e.erro)t(e);else{var i={rua:e.logradouro,cidade:e.localidade,bairro:e.bairro,uf:e.uf,pais:"Brasil"};t(i)}})}},ChartPedidos={type:"line",labels:[],data:[],chart:null,el:null,label:"",init:function(e,t,i,a){this.label=t,this.el=e,this.labels=i,this.data=a,this.constructElement()},constructElement:function(){var e=document.getElementById(this.el);e.height=300,this.chart=new Chart(e,{type:this.type,data:{labels:this.labels,datasets:[{label:this.label,data:this.data,backgroundColor:["rgba(255, 99, 132, 0.2)"],borderColor:["rgba(255,99,132,1)"],borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}})}},FormPedido=function(e,t,i){var a=null,n=null,o=0,s=0;this.init=function(){$this=this,a=new FormWizard(".form-wizard.form-pedido",{numero:{rules:"required",keyUp:function(e,t){$this.keyUpNumero(e,t)},hasLoading:!0},data_de_compra:{rules:"required",isDate:!0,onChangeDate:function(){}}},function(){$this.submit()}),i()},this.submit=function(){var i=a.getAll();i.id=o,i.idSolicitante=s,t.setData(i),e.paginatorForms.setSelectedPage("formSolicitante")},this.keyUpNumero=function(e,t){t.status&&(clearTimeout(n),n=setTimeout(function(){""!=a.get("numero")?(a.setDisabled(["numero","data_de_compra"]),a.showLoading("numero"),Database.findPedidoByNumero(a.get("numero"),function(e){if(a.setEnabled(["numero"]),1==e.length){e=e[0],a.setValue(e),a.verifySubmitEnaled(),e.total=e.total_materiais+e.total_insumos;var t=$(".fields-pedido");for(var i in e){var n=e[i];"total_materiais"!=i&&"total_insumos"!=i&&"total"!=i||(n=n.toFixed(2)),t.find('li[data-field="'+i+'"] span').text(n)}o=e.id,s=e.id_solicitante,$(".about-pedido").removeClass("hide")}else o=0,$(".about-pedido").addClass("hide");a.setEnabled(["data_de_compra"]),a.hideLoading("numero")})):$(".about-pedido").addClass("hide")},1e3))},this.init()},FormSolicitante=function(e,t,i){var a=null,n=null;this.init=function(){var e=this;a=new FormWizard(".form-solicitante",{nome:{rules:"required|min:3|max:100"},telefone:{rules:"required",mask:"(00) 00000-0000"},cpf:{rules:"required",mask:"000.000.000-00",onCompleteMask:function(){e.searchSolicitante()},hasLoading:!0},cep:{rules:"required",mask:"00000-000",onCompleteMask:function(t){e.searchCep(t)},hasLoading:!0},rua:{rules:"required|min:3"},numero:{rules:"required"},complemento:{},estado:{rules:"required",select:!0},cidade:{rules:"required|min:3"}},function(){e.submit()}),this.load()},this.submit=function(){var i=a.getAll();t.setSolicitante(i),e.paginatorForms.setSelectedPage("formMaterial")},this.load=function(){var e=this;0==t.get("id")?i():Database.findSolicitanteById(t.get("idSolicitante"),function(t){if(0==t.length)a.setEnabled(["cep","nome","telefone"]);else{var n=t[0];e.setValueForm(n),e.formSolicitante.validateAllFields(),e.formSolicitante.verifySubmitEnaled()}i()})},this.setValueForm=function(e){e.cpf=s(e.cpf),e.cep=r(e.cep),e.telefone=o(e.telefone),a.setValue(e),a.setAllEnabled()};var o=function(e){return $("<div>"+e.replace("(").replace(")")+"</div>").mask("(00) 00000-0000").text()},s=function(e){return $("<div>"+e+"</div>").mask("000.000.000-00").text()},r=function(e){return $("<div>"+e+"</div>").mask("00000-000").text()};this.searchCep=function(e){var t=["rua","numero","complemento","cidade","uf"];a.setDisabled(t),CEP.getInfo(e,function(e){a.setValue(e),a.setEnabled(t)})},this.searchSolicitante=function(){var e=this;clearTimeout(n),n=setTimeout(function(){a.setDisabled(["cpf"]);var t=a.getCleanValue("cpf");a.showLoading("cpf"),Database.findSolicitanteByCpf(t,function(t){0==t.length?a.setEnabled(["cep","nome","telefone"]):(e.setValueForm(t[0]),a.validateAllFields(),a.verifySubmitEnaled()),a.hideLoading("cpf")})},1e3)},this.init()},FormMaterial=function(e,t,i){},Core={paginatorMenu:null,paginatorForms:null,validator:null,formPedido:null,formSolicitante:null,formMaterial:null,pedido:null,init:function(){var e=this;this.paginatorMenu=new Paginator(".page-change",".paginator",function(t,i,a){e.pages[t](e,a)}),this.paginatorMenu.init(),String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)},this.paginatorMenu.setSelectedPage("dashboard1"),$(".change-sub-navbar").click(function(){e.changeSubNavbar($(this).data("subnavbar"))}),$(".navbar .navbar-nav a").click(function(){$(".navbar .navbar-nav li").removeClass("active"),$(this).addClass("active")})},changeSubNavbar:function(e){$(".sub-navbar").addClass("hide"),$(".sub-navbar."+e).removeClass("hide")},pages:{dashboard1:function(e,t){Database.fetchPedidosPorDia(function(i){i=e.prepareResultPorDia(i),ChartPedidos.init("chartOne","# pedidos por dia",i.labels,i.data),t()})},dashboard2:function(e,t){Database.fetchPedidosPorSolicitantes(function(i){i=e.prepareResultPorSolicitante(i),ChartPedidos.init("chartTwo","# pedidos por solicitante",i.labels,i.data),t()})},dashboard3:function(e,t){Database.fetchAllPedidos(function(e){var i=[];for(var a in e){var n=Number(e[a].total_materiais)+Number(e[a].total_insumos);i.push([e[a].numero,e[a].nome,e[a].data_de_compra.replaceAll("-","/"),"R$ "+e[a].total_materiais.toFixed(2),"R$ "+e[a].total_insumos.toFixed(2),"R$ "+n.toFixed(2)])}$("#table-pedidos").DataTable({columns:[{title:"Numero"},{title:"Solicitante"},{title:"Data de compra"},{title:"Total em Materiais"},{title:"Total em Insumos"},{title:"Total da compra"}],data:i}),t()})},process:function(e,t){e.pedido||(e.pedido=new Pedido),e.paginatorForms=new Paginator("--",".paginator.forms",function(t,i,a){e.changeTitleHeader(i),"formPedido"==t?e.formPedido||(e.formPedido=new FormPedido(e,e.pedido,a)):"formSolicitante"==t?e.formSolicitante||(e.formSolicitante=new FormSolicitante(e,e.pedido,a)):"formMaterial"==t&&(e.formMaterial||(e.formMaterial=new FormMaterial(e,e.pedido,a)))}),e.paginatorForms.init(),e.paginatorForms.setSelectedPage("formPedido"),t()}},changeTitleHeader:function(e){$(".title-header h2").text(e)},prepareResultPorSolicitante:function(e){var t={labels:[],data:[]};for(var i in e)t.labels.push(e[i].nome),t.data.push(e[i].total);return t},prepareResultPorDia:function(e){var t={data:[],labels:[]};for(var i in e)t.labels.push(this.prepareNumber(e[i].day)),t.data.push(e[i].total);return t},prepareNumber:function(e){return e<10?"0"+e:e}};Core.init();