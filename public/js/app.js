var Database={fetchAllPedidos:function(e){this._execute("SELECT * FROM pedidos",e)},findMaterialByPedidoId:function(e,a){var t="SELECT * FROM materiais WHERE id_pedido ="+e;this._execute(t,a)},fetchAllSolicitantes:function(e){this._execute("SELECT * FROM solicitantes",e)},fetchPedidosPorDia:function(e){this._execute("select count(*) as total, day(STR_TO_DATE(data_de_compra, '%Y-%m-%d')) as day from pedidos p group by day(STR_TO_DATE(data_de_compra, '%Y-%m-%d'))",e)},fetchPedidosPorSolicitantes:function(e){this._execute("select count(*) total, s.nome from pedidos p inner join solicitantes s on s.id = p.id_solicitante group by p.id_solicitante",e)},_execute:function(e,a){mysqlQuery(e,function(e){var t=JSON.parse(e);a(t)})}},Validator=function(e,a){var t={required:function(a){return e.val().length>0},max:function(a){return e.val().length<=a},min:function(a){return e.val().length>=a}},i=[];this.validate=function(e){for(var a in i){var n=i[a];if(!t[n.name]||!t[n.name](n.opt))return void e(n,!1)}e({},!0)},function(){var e=a.split("|");for(var t in e){var n=e[t].split(":");i[n[0]]={name:n[0],opt:n[1]}}}()},FormWizard=function(e,a){var t=$(e),i=[],n=function(){for(var e in a)r(e,a[e])},r=function(e,a){$elField=t.find('input[name="'+e+'"]'),i[e]={el:$elField},a.rules&&(i[e].validator=new Validator($elField,a.rules)),l(i[e]),a.isDate&&s(i[e]),a.mask&&o(i[e],a.mask,a.onCompleteMask)},o=function(e,a,t){var i={onComplete:t||function(){}};e.el.mask(a,i)},s=function(e){e.el.datepicker({format:"dd/mm/yyyy",language:"pt-BR"})},l=function(e){e.el.on("keyup",function(){e.validator&&d(i[$(this).attr("name")])})},d=function(e){e.validator.validate(function(a,t){var i=e.el.parent();i.find(".validator-errors span").removeClass("show"),t?i.removeClass("has-error").addClass("has-success"):(console.log('.validator-errors span[data-error="'+a.name+'"]'),i.find('.validator-errors span[data-error="'+a.name+'"]').addClass("show"),i.addClass("has-error"))})};this.setValue=function(e){for(var a in e)i[a]&&i[a].el.attr("value",e[a])},this.setEnabled=function(e){for(var a in e)i[e[a]]&&i[e[a]].el.removeAttr("disabled")},this.setDisabled=function(e){for(var a in e)i[e[a]]&&i[e[a]].el.attr("disabled","disabled")},this.init=function(){n()},this.init()},Paginator=function(e,a){var t=this,i=$(e),n=$(a),r=function(){i.click(function(){$(this).hasClass("enabled")&&t.setSelectedPage($(this).attr("href").replace("#",""))})};this.init=function(){r()},this.setSelectedPage=function(e){n.find(".page").removeClass("show-page").addClass("hide-page"),this.selectedPage=n.find("div[data-page="+e+"]"),this.selectedPage.addClass("show-page").removeClass("hide-page")}},CEP={getInfo:function(e,a){$.getJSON("https://viacep.com.br/ws/"+e+"/json/",function(e){if(e.erro)a(e);else{var t={rua:e.logradouro,cidade:e.localidade,bairro:e.bairro,uf:e.uf,pais:"Brasil"};a(t)}})}},ChartPedidos={type:"line",labels:[],data:[],chart:null,el:null,label:"",init:function(e,a,t,i){this.label=a,this.el=e,this.labels=t,this.data=i,this.constructElement()},constructElement:function(){var e=document.getElementById(this.el);e.height=300,this.chart=new Chart(e,{type:this.type,data:{labels:this.labels,datasets:[{label:this.label,data:this.data,backgroundColor:["rgba(255, 99, 132, 0.2)"],borderColor:["rgba(255,99,132,1)"],borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}})}},Core={paginatorMenu:null,validator:null,formPedido:null,init:function(){var e=this;this.paginatorMenu=new Paginator("#menu ul a",".paginator"),this.paginatorMenu.init(),this.formPedido=new FormWizard(".form-wizard.form-pedido",{data_de_compra:{isDate:!0},cep:{mask:"00000-000",onCompleteMask:function(a){e.searchCep(a)}},nome:{rules:"required|min:3|max:10"},rua:{rules:"required|min:3"}}),this.createGraphOne(),this.createGraphTwo(),this.createTable()},createTable:function(){$("#table-pedidos").DataTable()},searchCep:function(e){var a=this,t=["rua","numero","complemento","cidade","estado"];this.formPedido.setDisabled(t),CEP.getInfo(e,function(e){a.formPedido.setValue(e),a.formPedido.setEnabled(t)})},createGraphOne:function(){$this=this,Database.fetchPedidosPorDia(function(e){e=$this.prepareResultPorDia(e),ChartPedidos.init("chartOne","# pedidos por dia",e.labels,e.data)})},createGraphTwo:function(){$this=this,Database.fetchPedidosPorSolicitantes(function(e){e=$this.prepareResultPorSolicitante(e),ChartPedidos.init("chartTwo","# pedidos por solicitante",e.labels,e.data)})},prepareResultPorSolicitante:function(e){var a={labels:[],data:[]};for(var t in e)a.labels.push(e[t].nome),a.data.push(e[t].total);return a},prepareResultPorDia:function(e){var a={data:[],labels:[]};for(var t in e)a.labels.push(this.prepareNumber(e[t].day)),a.data.push(e[t].total);return a},prepareNumber:function(e){return e<10?"0"+e:e}};Core.init();