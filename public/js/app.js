var Database={fetchAllPedidos:function(e){this._execute("select p.numero, s.nome, DATE_FORMAT(STR_TO_DATE(p.data_de_compra, '%Y-%m-%d'), '%d-%m-%Y') as data_de_compra, (SELECT SUM (m.quantidade*m.preco) FROM materiais as m WHERE m.id_pedido = p.id) as total_materiais, (SELECT SUM (i.quantidade*i.preco) FROM insumos as i WHERE i.id_pedido = p.id) as total_insumos from pedidos as p INNER JOIN solicitantes as s ON s.id = p.id_solicitante",e)},findMaterialByPedidoId:function(e,t){var a="SELECT * FROM materiais WHERE id_pedido ="+e;this._execute(a,t)},fetchAllSolicitantes:function(e){this._execute("SELECT * FROM solicitantes",e)},fetchPedidosPorDia:function(e){this._execute("select count(*) as total, day(STR_TO_DATE(data_de_compra, '%Y-%m-%d')) as day from pedidos p group by day(STR_TO_DATE(data_de_compra, '%Y-%m-%d'))",e)},fetchPedidosPorSolicitantes:function(e){this._execute("select count(*) total, s.nome from pedidos p inner join solicitantes s on s.id = p.id_solicitante group by p.id_solicitante",e)},_execute:function(e,t){mysqlQuery(e,function(e){var a=JSON.parse(e);t(a)})}},Validator=function(e,t){var a={required:function(t){return e.val().length>0},max:function(t){return e.val().length<=t},min:function(t){return e.val().length>=t}},i=[];this.validate=function(e){for(var t in i){var o=i[t];if(!a[o.name]||!a[o.name](o.opt))return void e(o,!1)}e({},!0)},function(){var e=t.split("|");for(var a in e){var o=e[a].split(":");i[o[0]]={name:o[0],opt:o[1]}}}()},FormWizard=function(e,t){var a=$(e),i=[],o=function(){for(var e in t)n(e,t[e])},n=function(e,t){t.select?$elField=a.find('select[name="'+e+'"]'):$elField=a.find('input[name="'+e+'"]'),i[e]={el:$elField,properties:t},t.rules&&(i[e].validator=new Validator($elField,t.rules)),l(i[e]),t.isDate&&s(i[e]),t.mask&&r(i[e],t.mask,t.onCompleteMask)},r=function(e,t,a){var i={onComplete:a||function(){}};e.el.mask(t,i)},s=function(e){e.el.datepicker({format:"dd/mm/yyyy",language:"pt-BR"})},l=function(e){e.el.on("keyup",function(){e.validator&&d(i[$(this).attr("name")])})},d=function(e){e.validator.validate(function(t,a){var i=e.el.parent();i.find(".validator-errors span").removeClass("show"),a?i.removeClass("has-error").addClass("has-success"):(i.find('.validator-errors span[data-error="'+t.name+'"]').addClass("show"),i.addClass("has-error"))})};this.setValue=function(e){for(var t in e)i[t]&&(i[t].properties.select?i[t].el.val(e[t]):i[t].el.attr("value",e[t]))},this.setEnabled=function(e){for(var t in e)i[e[t]]&&i[e[t]].el.removeAttr("disabled")},this.setDisabled=function(e){for(var t in e)i[e[t]]&&i[e[t]].el.attr("disabled","disabled")},this.init=function(){o()},this.init()},Paginator=function(e,t,a){var i=this,o=$(e),n=$(t),r={},s=function(){o.click(function(){$(this).hasClass("enabled")&&i.setSelectedPage($(this).attr("href").replace("#",""))})};this.init=function(){s()},this.loadHtml=function(e,t,a){$.ajax({url:"views/"+e+".html"}).done(function(e){t.find(".content").html(e),a()})},this.setSelectedPage=function(e){i=this,n.find(".page").removeClass("show-page").addClass("hide-page"),this.selectedPage=n.find("div[data-page="+e+"]"),this.selectedPage.addClass("show-page").removeClass("hide-page");var t=function(){i.selectedPage.find(".loading").addClass("hide"),i.selectedPage.find(".content").addClass("show")};r.page?a(e,t):this.loadHtml(e,this.selectedPage,function(){a(e,t)})}},CEP={getInfo:function(e,t){$.getJSON("https://viacep.com.br/ws/"+e+"/json/",function(e){if(e.erro)t(e);else{var a={rua:e.logradouro,cidade:e.localidade,bairro:e.bairro,uf:e.uf,pais:"Brasil"};t(a)}})}},ChartPedidos={type:"line",labels:[],data:[],chart:null,el:null,label:"",init:function(e,t,a,i){this.label=t,this.el=e,this.labels=a,this.data=i,this.constructElement()},constructElement:function(){var e=document.getElementById(this.el);e.height=300,this.chart=new Chart(e,{type:this.type,data:{labels:this.labels,datasets:[{label:this.label,data:this.data,backgroundColor:["rgba(255, 99, 132, 0.2)"],borderColor:["rgba(255,99,132,1)"],borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}})}},Core={paginatorMenu:null,validator:null,formPedido:null,formSolicitante:null,init:function(){var e=this;this.paginatorMenu=new Paginator(".page-change",".paginator",function(t,a){e.pages[t](e,a)}),this.paginatorMenu.init(),String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)},this.paginatorMenu.setSelectedPage("dashboard1")},searchCep:function(e){var t=this,a=["rua","numero","complemento","cidade","uf"];this.formSolicitante.setDisabled(a),CEP.getInfo(e,function(e){t.formSolicitante.setValue(e),t.formSolicitante.setEnabled(a)})},pages:{dashboard1:function(e,t){Database.fetchPedidosPorDia(function(a){a=e.prepareResultPorDia(a),ChartPedidos.init("chartOne","# pedidos por dia",a.labels,a.data),t()})},dashboard2:function(e,t){Database.fetchPedidosPorSolicitantes(function(a){a=e.prepareResultPorSolicitante(a),ChartPedidos.init("chartTwo","# pedidos por solicitante",a.labels,a.data),t()})},dashboard3:function(e,t){Database.fetchAllPedidos(function(e){var a=[];for(var i in e){var o=Number(e[i].total_materiais)+Number(e[i].total_insumos);a.push([e[i].numero,e[i].nome,e[i].data_de_compra.replaceAll("-","/"),"R$ "+e[i].total_materiais.toFixed(2),"R$ "+e[i].total_insumos.toFixed(2),"R$ "+o.toFixed(2)])}$("#table-pedidos").DataTable({columns:[{title:"Numero"},{title:"Solicitante"},{title:"Data de compra"},{title:"Total em Materiais"},{title:"Total em Insumos"},{title:"Total da compra"}],data:a}),t()})},process:function(e,t){e.formPedido=new FormWizard(".form-wizard.form-pedido",{data_de_compra:{isDate:!0}}),e.formSolicitante=new FormWizard(".form-wizard.form-solicitante",{nome:{rules:"required|min:3|max:10"},telefone:{mask:"(00) 00000-0000"},cpf:{mask:"000.000.000-00"},cep:{mask:"00000-000",onCompleteMask:function(t){e.searchCep(t)}},rua:{rules:"required|min:3"},numero:{rules:"required"},complemento:{rules:"required"},uf:{rules:"required",select:!0},cidade:{rules:"required|min:3"}}),t()}},prepareResultPorSolicitante:function(e){var t={labels:[],data:[]};for(var a in e)t.labels.push(e[a].nome),t.data.push(e[a].total);return t},prepareResultPorDia:function(e){var t={data:[],labels:[]};for(var a in e)t.labels.push(this.prepareNumber(e[a].day)),t.data.push(e[a].total);return t},prepareNumber:function(e){return e<10?"0"+e:e}};Core.init();