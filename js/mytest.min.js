function createObject(a,b,c,d){function e(b,c){a[b].solicitante=c}function f(b,c){a[b].materiais=[],a[b].materiais.push(c)}for(var g=0;g<a.length;g++){a[g].isPendente=!0;for(var h=0;h<b.length;h++)a[g].id_solicitante===b[h].id&&e(g,b[h]);for(var h=0;h<c.length;h++)if(a[g].id===c[h].id_pedido){a[g].insumos=[],f(g,c[h]);for(var i=0;i<d.length;i++)a[g].id===d[i].id_pedido&&a[g].insumos.push(d[i])}}return a}function makeRoundImage(a){$(a).css({display:"block","-moz-border-radius":$(a).height()/2+"px","-webkit-border-radius":$(a).height()/2+"px","border-radius":$(a).height()/2+"px"})}function performQuerys(a,b,c,d,e){mysqlQuery(b,function(b){solicitantes=JSON.parse(b),mysqlQuery(a,function(a){pedidos=setDataCompra(JSON.parse(a)),mysqlQuery(c,function(a){insumos=JSON.parse(a),mysqlQuery(d,function(a){materiais=JSON.parse(a),$(".materialSelect").each(function(){$(this).append("<option value='-1' disabled selected hidden>Escolha um material</option>");for(var a=0;a<materiais.length;a++)$(this).append("<option value="+materiais[a].id+">"+materiais[a].nome+" "+materiais[a].marca+"-- Preço:R$"+materiais[a].preco+",00</option>")}),e(createObject(pedidos,solicitantes,materiais,insumos),setPedidosPorSolicitante(pedidos,solicitantes),setPedidosPorDia(pedidos),insumos,materiais)})})})})}function setDomListenersAndLike(a,b,c,d,e){$("#pedidoNumberInput").mask("9"),$("#dataInput").mask("99/99/9999",{placeholder:"DD/MM/YYYY"}),$(".materialQtdSelect").each(function(){for(var a=1;a<16;a++){var b=a-1;$(this).append("<option value="+b+">"+a+"</option>")}}),$("#solicitanteCEPInput").mask("99999-999"),$("#solicitanteCPFInput").mask("999.999.999-99"),$("#solicitanteNumInput").mask("9999999"),$("#entregaCEPInput").mask("99999-999"),$("#pedidoNumberInput").siblings().click(function(c){c.preventDefault();var d=$("#pedidoNumberInput").val();pedido=setPedidoFromNum(b,a,d),updateTotalCost(pedido)}),$("#pedidosTable tbody").on("click","tr",function(){$(this).addClass("selected").siblings().removeClass("selected");var c=parseInt($(this).find("td").first().html());pedido=setPedidoFromNum(b,a,c),updateTotalCost(pedido)}),$("#addInsumosButton").click(function(){var a=$(this).siblings();if(a[0].value!=-1)for(var c=0;c<e.length;c++)if(e[c].id==a[0].value)return pedido.insumos.push(e[c]),pedido.insumos[pedido.insumos.length-1].id_pedido=pedido.id,pedido.insumos[pedido.insumos.length-1].quantidade=parseInt(a[1].value)+1,setInsumosTable(b,pedido),void updateTotalCost(pedido)}),$(".materialSelect").change(function(){var a=[];$(".materialSelect").each(function(){for(var b=0;b<d.length;b++)d[b].id==this.value&&(a.push(d[b]),a[a.length-1].quantidade=parseInt($(this).siblings()[0].value)+1,a[a.length-1].id_pedido=pedido.id)}),pedido.materiais=a,updateTotalCost(pedido)}),$(".materialQtdSelect").change(function(){if($(this).siblings()[0].value!=-1){for(var a=parseInt(this.value)+1,b=0;b<pedido.materiais.length;b++)pedido.materiais[b].id==$(this).siblings()[0].value&&(pedido.materiais[b].quantidade=a);updateTotalCost(pedido)}}),$("#searchSolicitanteCEPButton").click(function(){getEndPeloCep($("#solicitanteCEPInput")[0].value.replace("-",""),function(a){console.log(a),$("#solicitanteCEPInput")[0].value=a.cep,$("#solicitanteCidadeInput")[0].value=a.localidade,$("#solicitanteUFInput")[0].value=a.uf,$("#solicitanteEndInput")[0].value=a.logradouro,$("#solicitanteBairroInput")[0].value=a.bairro,$("#solicitanteNumInput")[0].value=[],$("#entregaCEPInput")[0].value=a.cep,$("#entregaCidadeInput")[0].value=a.localidade,$("#entregaUFInput")[0].value=a.uf,$("#entregaEndInput")[0].value=a.logradouro,$("#entregaBairroInput")[0].value=a.bairro,$("#entregaNumInput")[0].value=[]})}),$("#finishPedidoButton").click(function(){pedido.insumos.length>1?4==pedido.materiais.length?pedidos[pedido.id-1].id==pedido.id&&(pedido.isPendente=!1,pedidos[pedido.id-1]=pedido,setPedidosTable(c,pedidos),clearAll(),$("#pedidosTable tbody").on("click","tr",function(){$(this).addClass("selected").siblings().removeClass("selected");var c=parseInt($(this).find("td").first().html());pedido=setPedidoFromNum(b,a,c),updateTotalCost(pedido)}),console.log(pedidos)):pedido.materiais.length<4?alert("Por favor, escolha 4 materiais"):alert("HOW DID THIS HAPPEN"):alert("Escolha, no mínimo, dois insumos")}),updateTotalCost(pedido)}function orderAndFormatArrayByDate(a){for(var b,c,d,e=0;e<a.length;e++)for(var f=e+1;f<a.length;f++)c=parseInt(a[e][0])+31*parseInt(a[e][1]),d=parseInt(a[f][0])+31*parseInt(a[f][1]),c>d&&(b=a[e],a[e]=a[f],a[f]=b);for(var e=0;e<a.length;e++)a[e]=a[e][0]+"/"+a[e][1];return a}function getPedidosPorDias(a,b){for(var d,c=[],e=0;e<a.length;e++){d=0;for(var f=0;f<b.length;f++)a[e]===b[f].dia_de_compra&&d++;c.push(d)}return c}function setPedidosPorDia(a){for(var b=[],c=[],d=0;d<a.length;d++)c.push(a[d].dia_de_compra.split("/"));c=orderAndFormatArrayByDate(c),b=getPedidosPorDias(c,a);var e={labels:c,datasets:[{label:"Número de Pedidos",fill:!1,lineTension:.1,backgroundColor:"rgba(75,192,192,0.4)",borderColor:"rgba(75,192,192,1)",borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",pointBorderColor:"rgba(75,192,192,1)",pointBackgroundColor:"#fff",pointBorderWidth:1,pointHoverRadius:5,pointHoverBackgroundColor:"rgba(75,192,192,1)",pointHoverBorderColor:"rgba(220,220,220,1)",pointHoverBorderWidth:2,pointRadius:1,pointHitRadius:10,data:b,spanGaps:!1}]};return e}function getDataSetPedidos(a){for(var b=[],c=0;c<a.length;c++)a[c].isPendente||a.splice(c,1);for(var c=0;c<a.length;c++)a[c].isPendente&&(b[c]=new Array,b[c].push(a[c].id),b[c].push(a[c].solicitante.nome),b[c].push(a[c].data_de_compra.split(" ")[0]));return b}function setPedidosPorSolicitante(a,b){for(var c=[],d=[],e=0;e<b.length;e++){for(var f=0,g=0;g<a.length;g++)a[g].id_solicitante===b[e].id&&f++;var h=b[e].nome.split(" ");b[e].nome.split(" ").length;h=h[0],c.push(h),d.push(f)}var j={labels:c,datasets:[{label:"Número de Pedidos",fill:!1,lineTension:.1,backgroundColor:"rgba(75,192,192,0.4)",borderColor:"rgba(75,192,192,1)",borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",pointBorderColor:"rgba(75,192,192,1)",pointBackgroundColor:"#fff",pointBorderWidth:1,pointHoverRadius:5,pointHoverBackgroundColor:"rgba(75,192,192,1)",pointHoverBorderColor:"rgba(220,220,220,1)",pointHoverBorderWidth:2,pointRadius:1,pointHitRadius:10,data:d,spanGaps:!1}]};return j}function setDataCompra(a){for(var b=0;b<a.length;b++){var c=a[b].data_de_compra.split(" ")[0].split("-")[2]+"/"+a[b].data_de_compra.split(" ")[0].split("-")[1];a[b].dia_de_compra=c}return a}function getDataSetInsumos(a){for(var b=[],c=0;c<a.materiais.length;c++)for(var e=(a.materiais[c],0);e<a.insumos.length;e++){var f=a.insumos[e];b[e]=new Array,b[e].push(f.descricao),b[e].push("R$"+Math.round(100*parseFloat(f.preco))/100),b[e].push(parseInt(f.quantidade)),b[e].push('<button data-id="'+f.id+'" data-qtd="'+f.quantidade+'" class="myButton" id="deleteInsumosButton" type="button" name="deleteInsumosButton">X</button>')}return b}function setInsumosSelect(a){for(var b=0;b<a.length;b++){var c="R$"+Math.round(100*parseFloat(a[b].preco))/100;$("#insumosSelect").append("<option value="+a[b].id+">"+a[b].descricao+" -- "+c+"</option>")}}function setPedidoFromNum(a,b,c){clearMaterialSelect();for(var d=0;d<b.length;d++)if(b[d].id==c&&b[d].isPendente){var e=b[d];return $("#pedidoNumberInput")[0].value=e.id,$("#dataInput")[0].value=e.data_de_compra.split(" ")[0],$("#nomeInput")[0].value=e.solicitante.nome,$("#solicitanteCPFInput")[0].value=e.solicitante.cpf,$("#solicitanteCEPInput")[0].value=e.cep,$("#solicitanteCidadeInput")[0].value=e.cidade,$("#solicitanteUFInput")[0].value=e.estado,$("#solicitanteEndInput")[0].value=e.rua,$("#solicitanteBairroInput")[0].value=e.bairro,$("#solicitanteNumInput")[0].value=e.numero,$("#entregaCEPInput")[0].value=e.cep,$("#entregaCidadeInput")[0].value=e.cidade,$("#entregaUFInput")[0].value=e.estado,$("#entregaEndInput")[0].value=e.rua,$("#entregaBairroInput")[0].value=e.bairro,$("#entregaNumInput")[0].value=e.numero,setInsumosTable(a,e),setMateriaisSelect(e),updateTotalCost(e),e}clearAll(),updateTotalCost(e)}function setSelectedValue(a,b){for(var c=$("#"+a)[0],d=0;d<c.options.length;d++)if(c.options[d].value==b)return void(c.options[d].selected=!0)}function setPedidosTable(a,b){var c=getDataSetPedidos(b);console.log(c),$("#pedidosTableWrap").children().remove(),$("#pedidosTableWrap").append("<table id='pedidosTable'></table>"),a=$("#pedidosTable").DataTable({lengthMenu:[5],data:c,columns:[{title:"Número do Pedido Pendente"},{title:"Solicitante"},{title:"Data de Compra"}]})}function setInsumosTable(a,b){var c=getDataSetInsumos(b);$("#tableSectionInsumos").children().remove(),$("#tableSectionInsumos").append("<table id='insumosTable'></table>");var a=$("#insumosTable").DataTable({lengthMenu:[8],data:c,columns:[{title:"Insumo"},{title:"Preço"},{title:"Qtd"},{title:"Apagar"}]});$("#insumosTable tbody").on("click","tr",function(c){if(console.log(c.target.id+""),"deleteInsumosButton"==c.target.id)for(var d=0;d<b.insumos.length;d++){var e=b.insumos[d];if(e.id==$(c.target).attr("data-id")&&e.quantidade==$(c.target).attr("data-qtd"))return console.log(b.insumos),b.insumos.splice(d,1),setInsumosTable(a,b),console.log(b.insumos),updateTotalCost(b),b}})}function setMateriaisSelect(a){for(var b=0;b<a.materiais.length;b++)setSelectedValue(b,a.materiais[b].id),setSelectedValue(b+""+b,a.materiais[b].quantidade)}function clearInsumoTable(){$("#tableSectionInsumos").children().remove(),$("#tableSectionInsumos").append("<table id='insumosTable'></table>");$("#insumosTable").DataTable({lengthMenu:[8],data:[],columns:[{title:"Insumo"},{title:"Preço"},{title:"Qtd"},{title:"Apagar"}]})}function clearMaterialSelect(){for(var a=0;a<4;a++)setSelectedValue(a,-1)}function getEndPeloCep(a,b){$.ajax({type:"get",url:"http://viacep.com.br/ws/"+a+"/json/",dataType:"json",success:function(a){b(a)}})}function updateTotalCost(a){if("undefined"!=typeof a){for(var b=0,c=0;c<a.materiais.length;c++)b+=a.materiais[c].preco*a.materiais[c].quantidade;for(var c=0;c<a.insumos.length;c++)b+=a.insumos[c].preco*a.insumos[c].quantidade;$("#finishButtonText").text("Preço Total: R$"+parseFloat(Math.round(100*b)/100).toFixed(2))}else $("#finishButtonText").text("Preço Total: R$0,00")}function clearAll(){$("#dataInput")[0].value=[],$("#nomeInput")[0].value=[],$("#solicitanteCPFInput")[0].value=[],$("#solicitanteCEPInput")[0].value=[],$("#solicitanteCidadeInput")[0].value=[],$("#solicitanteUFInput")[0].value=[],$("#solicitanteEndInput")[0].value=[],$("#solicitanteBairroInput")[0].value=[],$("#solicitanteNumInput")[0].value=[],$("#entregaCEPInput")[0].value=[],$("#entregaCidadeInput")[0].value=[],$("#entregaUFInput")[0].value=[],$("#entregaEndInput")[0].value=[],$("#entregaBairroInput")[0].value=[],$("#entregaNumInput")[0].value=[],$("#finishButtonText").text("Preço Total: R$0,00"),clearInsumoTable(),clearMaterialSelect()}var pedido;window.onload=function(){var e="SELECT * FROM solicitantes",f="SELECT * FROM pedidos ORDER BY id ASC",g="SELECT * FROM insumos",h="SELECT * FROM materiais";performQuerys(f,e,g,h,function(a,b,c,d,e){var h=(new Chart($("#myLeftChart"),{type:"bar",data:b,options:{responsive:!1,title:{display:!0,text:"Pedidos por Solicitante"},scales:{yAxes:[{ticks:{beginAtZero:!0,max:5,min:0,stepSize:1}}]}}}),new Chart($("#myRightChart"),{type:"bar",data:c,options:{responsive:!1,min:1,title:{display:!0,text:"Pedidos por Dia"},scales:{yAxes:[{ticks:{beginAtZero:!0,max:5,min:0,stepSize:1}}]}}}),$("#insumosTable").DataTable({data:[],columns:[{title:"Insumo"},{title:"Preço"},{title:"Qtd"},{title:"Apagar"}]})),i=$("#pedidosTable").DataTable({data:[],columns:[{title:"Número do Pedido Pendente"},{title:"Solicitante"},{title:"Data de Compra"}]});setPedidosTable(i,a),setDomListenersAndLike(a,h,i,e,d),setInsumosSelect(d)}),$("body, html").mousewheel(function(a,b){this.scrollLeft-=30*b,a.preventDefault()}),makeRoundImage($("#profileImg").find("img")[0])};